/**
* GO Query!
* Query executor on js array of objects
* Build date: 2014-12-04
* @author Rubens Pinheiro Gon√ßalves Cavalcante <rubenspgcavalcante@gmail.com>
* @version 1.0.2
* @license GPLv3
*/
!function(a,b){"function"==typeof define&&define.amd?define(["exports"],function(c){b(a.GO=c)}):b("object"==typeof GO?module:a.GO={})}(this,function(a){"use strict";return a.Clause={},a.Core={},a.Core.Modifier={},a.Core.Helpers={},a.Error={},a.Utils={},a.query={},a.query.type={SELECT:0,DELETE:1,UPDATE:2},a.query.logic_op={AND:0,OR:1,XOR:2},a.query.WILDCARD="*",a.op={TAUTOLOGICAL:0,CONTRADICTORY:1,EQ:2,NEQ:3,GT:4,GTE:5,MT:6,MTE:7,LIKE:8,HAS:9},a.order={ASC:0,DESC:1},a.comparison={GREATER:1,EQUALS:0,LESSER:-1},function(a){a.Query=function(b){var c=new a.Core.Record;this._getRecord=function(){return c},this._setRecord=function(a,b){c[a]instanceof Array?c[a].push(b):c[a]=b},this.select=function(){return c.type=a.query.type.SELECT,c.selection=arguments,new a.Clause.From(this)},this.update=function(){return c.type=a.query.type.UPDATE,c.selection=a.query.WILDCARD,new a.Clause.From(this)},this.remove=function(){return c.type=a.query.type.DELETE,c.selection=arguments,new a.Clause.From(this)},this.clear=function(){return this.splice(0,this.length),this},this.setData=function(a){a=a||[],this.clear();for(var b=0,c=a.length;c>b;b++)this.push(a[b]);return this},this.clearRecord=function(){return c=new a.Query.Record,this},function(a,b){a.setData(b)}(this,b)},a.Query.prototype=[]}(a),function(a){a.Filter=function(b,c,d){b instanceof a.Filter?this.associate=b||null:(this.attribute=b||null,this.operator=c||a.op.TAUTOLOGICAL,this.value=d||null);var e=null,f=null;this._setPredecessor=function(a){e=a},this._getFilterChain=function(){return f},this.back=function(){return e},this.next=function(){return f.link},this.root=function(){for(var a=this;null!=a.back();)a=a.back();return a},this.isEmpty=function(){return this.hasOwnProperty("associate")?null==this.associate:null==this.attribute&&null==this.value},this.init=function(b,c,d){b instanceof a.Filter?this.associate=b:(this.attribute=b,this.operator=c,this.value=d)},this.and=function(b,c,d){var e=new a.Filter(b,c,d);return e._setPredecessor(this),f=new a.Core.FilterChain(a.query.logic_op.AND,e),e},this.or=function(b,c,d){var e=new a.Filter(b,c,d);return e._setPredecessor(this),f=new a.Core.FilterChain(a.query.logic_op.OR,e),e},this.xor=function(b,c,d){var e=new a.Filter(b,c,d);return e._setPredecessor(this),f=new a.Core.FilterChain(a.query.logic_op.XOR,e),e}}}(a),function(a){a.Error.CloneError=function(a){this.name="CloneError",this.message="Object couldn't be cloned. One or more inner attributes types are not supported",this.data=a||null},a.Error.CloneError.prototype=new Error}(a),function(a){a.Error.NotImplementedError=function(a,b){this.name="NotImplementedError",this.message="Constructor must implement "+a,this.data=b||null},a.Error.NotImplementedError.prototype=new Error}(a),function(a){a.Error.OperatorError=function(a,b){this.name="OperatorError",this.message=a,this.data=b||null},a.Error.OperatorError.prototype=new Error}(a),function(a){a.Error.PropertyNotDefinedError=function(a,b){this.msg="Property "+a+" is not defined",this.data=b},a.Error.PropertyNotDefinedError.prototype=new Error}(a),function(a){a.Error.QueryMethodError=function(a,b){this.name="QueryMethodError",this.message=a,this.data=b||null},a.Error.QueryMethodError.prototype=new Error}(a),function(a){a.Utils.ObjectUtils={_deepSearch:function(b,c,d,e){if(null==b)return null;var f=b.indexOf("."),g=null;if(-1!=f){var h=b.slice(0,f);if(b=b.slice(f+1),!c.hasOwnProperty(h))throw new a.Error.PropertyNotDefinedError(h,c);g=c[h]||null}else g=c;return-1!=b.indexOf(".")&&null!=g?this._deepSearch(g,b,d):d?(delete g[b],null):"undefined"!=typeof e?(g[b]=e,null):g[b]},unsafeDeepSelect:function(a,b){return this._deepSearch(a,b)},deepSelect:function(b,c){try{return this._deepSearch(b,c)}catch(d){if(d instanceof a.Error.PropertyNotDefinedError)return null}},deepSet:function(b,c,d){try{this._deepSearch(b,c,!1,d)}catch(e){if(e instanceof a.Error.PropertyNotDefinedError)return!1}return!0},deepDelete:function(b,c){try{this._deepSearch(b,c,!0)}catch(d){if(d instanceof a.Error.PropertyNotDefinedError)return!1}return!0}}}(a),function(a){a.Clause.From=function(b){var c=b;this.from=function(b){return"undefined"==typeof b&&(b=Object),c._setRecord("from",b),new a.Clause.Where(c)}}}(a),function(a){a.Clause.Where=function(b){var c=b;b._setRecord("where",this);var d={};this.filter=null;var e=function(){var b=c._getRecord();switch(b.type){case a.query.type.SELECT:d.orderBy=new a.Core.Modifier.OrderBy(b);break;case a.query.type.UPDATE:d.set=new a.Core.Modifier.Set(b)}};this.where=function(b){return b=b||new a.Filter("",a.op.TAUTOLOGICAL,""),this.filter=b.root(),e(),new a.Core.Processor(c,d)}}}(a),function(a){a.Core.Modifier.PostProcess=function(b){this._processor=null,this.modifierName=b,this.setProcessorReference=function(a){this._processor=a},this.init=function(){throw new a.Error.NotImplementedError("init",this.constructor)},this.modify=function(){throw new a.Error.NotImplementedError("modify",this.constructor)}}}(a),function(a){a.Core.Modifier.OrderBy=function(b){b.modifiers.push(this);var c=this,d=null,e=null,f=null,g={number:function(b,c,d){return d==a.order.ASC?b-c:c-b},string:function(b,c,d){var e=null;return e=b>c?1:c>b?-1:0,d==a.order.ASC?e:!e}};this.init=function(a,b,g){return d=a,e=b,f=g||null,c._processor},this.modify=function(b){b.sort(null==f?function(b,c){try{var f=a.Utils.ObjectUtils.unsafeDeepSelect(d,b),h=a.Utils.ObjectUtils.unsafeDeepSelect(d,c);if(g.hasOwnProperty(typeof f))return g[typeof f](f,h,e)}catch(i){}return 0}:f)}},a.Core.Modifier.OrderBy.prototype=new a.Core.Modifier.PostProcess("OrderBy"),a.Core.Modifier.OrderBy.constructor=a.Core.Modifier.OrderBy}(a),function(a){a.Core.Modifier.Set=function(b){b.modifiers.push(this);var c=null,d=this;this.init=function(a){return c=a,d._processor},this.modify=function(b){for(var d=0;d<b.length;d++)for(var e in c)c.hasOwnProperty(e)&&a.Utils.ObjectUtils.deepSet(e,b[d],c[e])}},a.Core.Modifier.Set.prototype=new a.Core.Modifier.PostProcess("Set")}(a),function(a){a.Core.FilterChain=function(a,b){this.link=b,this.type=a}}(a),function(a){a.Core.Processor=function(b,c){var d=this,e=b;!function(){if("undefined"!=typeof c)for(var a in c)c.hasOwnProperty(a)&&(c[a].setProcessorReference(d),d[a]=c[a].init)}();var f=function(b,c){var d=!1;if(c.hasOwnProperty("associate"))d=f(b,c.associate);else{var e=a.Utils.ObjectUtils.deepSelect(c.attribute,b);d=new a.Core.Validator(c,e).test()}var g=c._getFilterChain();if(null!=g){var h=a.query.logic_op;switch(g.type){case h.AND:return d&&f(b,c.next());case h.OR:return d||f(b,c.next());case h.XOR:return d&&!f(b,c.next())||!d&&f(b,c.next())}}return d},g=function(b,c){var d={},e=c.indexOf(".");if(c==a.query.WILDCARD)d=b;else if(-1==e)d[c]="object"==typeof b[c]?JSON.parse(JSON.stringify(b[c])):b[c];else{var f=c.slice(0,e);c=c.slice(e+1),d[f]=b[f]||null,-1!=c.indexOf(".")?d[f]=g(d[f],c):"object"==typeof d[f]&&(d=JSON.parse(JSON.stringify(d)))}return d},h=function(b){var c=[],d=e._getRecord().selection;0==d.length&&(d=[a.query.WILDCARD]);for(var f=0,h=b.length;h>f;f++){for(var i={},j=0,k=d.length;k>j;j++)a.Core.Helpers.objectMerge(i,g(b[f],d[j]));c.push(i)}return c},i=function(a){for(var b=0,c=e.length;c>b;b++){var d=e[b];d instanceof e._getRecord().from&&f(d,e._getRecord().where.filter)&&a(d)}},j=function(){var a=[];return i(function(b){a.push(b)}),h(a)},k=function(){i(function(b){var c=e._getRecord().selection;for(var d in c)a.Utils.ObjectUtils.deepDelete(c[d],b)})},l=function(a){for(var b=e._getRecord().modifiers,c=0;c<b.length;c++)b[c].modify(a);return a};this.run=function(){var b=null,c=e._getRecord();switch(c.type){case a.query.type.SELECT:case a.query.type.UPDATE:b=j();break;case a.query.type.DELETE:b=k();break;default:throw new a.Error.QueryMethodError("Query method not found",e._getRecord())}return l(b)}}}(a),function(a){a.Core.Record=function(){this.type=null,this.selection=null,this.from=null,this.where=null,this.modifiers=[]}}(a),function(a){a.Core.Validator=function(b,c){var d=this;this.filter=b,this.value=c;var e=function(){if(d.value instanceof Array)for(var a in d.value)if(d.filter.value==d.value[a])return!0;return!1};this.test=function(){switch(this.filter.operator){case a.op.EQ:return this.value==this.filter.value;case a.op.NEQ:return this.value!=this.filter.value;case a.op.GTE:return this.value>=this.filter.value;case a.op.MTE:return this.value<=this.filter.value;case a.op.GT:return this.value>this.filter.value;case a.op.MT:return this.value<this.filter.value;case a.op.LIKE:return this.filter.value instanceof RegExp&&this.filter.value.test(this.value);case a.op.HAS:return e();case a.op.TAUTOLOGICAL:return!0;case a.op.CONTRADICTORY:return!1;default:throw new a.Error.OperatorError("Operator doesn't exist",this.filter)}}}}(a),function(a){a.Core.Helpers={deepSearch:function(b,c,d){var e=c.indexOf(".");if(-1!=e){var f=c.slice(0,e);return c=c.slice(e+1),a.Core.Helpers.deepSearch(b[f],c,d)}return"undefined"==typeof d?b[c]:void(b[c]=d)},deepSelection:function(b,c){var d=c.indexOf("."),e=null;if(-1==d)e[c]=a.Core.Helpers.clone(b[c]);else{var f=c.slice(0,d);c=c.slice(d+1),e[f]=b[f]||null,-1!=c.indexOf(".")?e[f]=a.Core.Helpers.deepSelection(e[f],c):e=a.Core.Helpers.clone(b)}return e},clone:function(b){if(null==b||"object"!=typeof b)return b;var c=null;if(b instanceof Date)return c=new Date,c.setTime(b.getTime()),c;if(b instanceof Array){c=[];for(var d=0,e=b.length;e>d;d++)c[d]=clone(b[d]);return c}if(b instanceof Object){c={};for(var f in b)b.hasOwnProperty(f)&&(c[f]=clone(b[f]));return c}throw new a.Error.CloneError(b)},objectMerge:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}}}(a),a});