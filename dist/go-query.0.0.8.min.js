/**
* Query executor on js array of objects
* Build date: 2013-09-27
* @author go-query
* @version 0.0.8
* @license GPLv3
*/
GO={},GO.Core={},GO.query={},GO.query.type={SELECT:0,DELETE:1,UPDATE:2},GO.query.WILDCARD="*",GO.op={TAUTOLOGICAL:0,CONTRADICTORY:1,EQ:2,NEQ:3,GT:4,GTE:5,MT:6,MTE:7,LIKE:8,HAS:9},GO.order={ASC:0,DESC:1},GO.Query.Filter=function(a,b,c){this.attribute=a,this.operator=b,this.value=c;var d=null,e={and:null,or:null,xor:null},f=function(a,b,c,d){for(var f in e)f==a?(e[i]=new GO.Query.Filter(b,c,d),e[i]._setParent(this)):e[i]=null;return e[a]};this._setParent=function(a){d=a},this.parent=function(){return d},this.child=function(){return e.and||e.or||e.xor},this.root=function(){for(var a=null;null!=this.parent();)a=this.parent();return a},this.isEmpty=function(){return null==typeof this.attribute&&null==typeof this.operator&&null==typeof this.value},this.and=function(a,b,c){return f("and",a,b,c)},this.or=function(a,b,c){return f("or",a,b,c)},this.xor=function(a,b,c){return f("xor",a,b,c)}},GO.Query=function(a){this.collection=a;var b={type:null,selection:null,from:null,where:null,updateTo:[],orderby:null};this._getRecord=function(){return b},this._setRecord=function(a,c){b[a]=c},this.select=function(){return b.type=GO.query.type.SELECT,b.selection=arguments,new GO.Query._From(this)},this.update=function(){return b.type=GO.query.type.UPDATE,new GO.Query._From(this)},this.remove=function(){return b.type=GO.query.type.DELETE,b.selection=arguments,new GO.Query._From(this)}},GO.Core.From=function(a){var b=a;this.from=function(a){return"undefined"==typeof a&&(a=Object),b._setRecord("from",a),new GO.Core.Where(b)}},GO.Core.Processor=function(a){var b=a,c=function(a,b,c,d){var e=b.indexOf("."),f=null;if(c=c||GO.query.type.SELECT,-1!=e){var g=b.slice(0,e);b=b.slice(e+1),f=a[g]||null}else f=a[b]||null;if(-1!=b.indexOf(".")&&null!=f)return _deepSearchAttribute(f,b);switch(c){case GO.query.type.SELECT:return f;case GO.query.type.UPDATE:a[b]=d;break;case GO.query.type.DELETE:delete a[b]}return null},d=function(a,b){var e=!1,f=c(a,b.attribute);switch(b.operator){case GO.op.EQ:f==b.value&&(e=!0);break;case GO.op.NEQ:f!=b.value&&(e=!0);break;case GO.op.GTE:f>=b.value&&(e=!0);break;case GO.op.MTE:f<=b.value&&(e=!0);break;case GO.op.GT:f>b.value&&(e=!0);break;case GO.op.MT:f<b.value&&(e=!0);break;case GO.op.LIKE:b.value instanceof RegExp&&b.value.test(f)&&(e=!0);break;case GO.op.HAS:if(f instanceof Array)for(var g in f)if(b.value==f[g]){e=!0;break}break;case GO.op.TAUTOLOGICAL:e=!0;break;case GO.op.CONTRADICTORY:e=!1;break;default:throw Error("Operator "+b.operator+" doesn't exists")}return e?null!=b.child()?d(a,b.child()):!0:!1},e=function(a,b){var c={},d=b.indexOf(".");if(b==GO.query.WILDCARD)c=JSON.parse(JSON.stringify(a));else if(-1==d)c[b]="object"==typeof a[b]?JSON.parse(JSON.stringify(a[b])):a[b];else{var f=b.slice(0,d);b=b.slice(d+1),c[f]=a[f]||null,-1!=b.indexOf(".")?c[f]=e(c[f],b):"object"==typeof c[f]&&(c=JSON.parse(JSON.stringify(c)))}return c},f=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},g=function(a){var c=[],d=b._getRecord().selection;0==d.length&&(d=[GO.query.WILDCARD]);for(var g in a){var h={};for(var i in d)f(h,e(a[g],d[i]));c.push(h)}return c},h=function(a){for(var c in b.collection){var e=b.collection[c];e instanceof b._getRecord().from&&d(e,b._getRecord().where.filter)&&a(e)}},i=function(){var a=[];return h(function(b){a.push(b)}),g(a)},j=function(){h(function(a){var d=b._getRecord().selection,e=b._getRecord().updateTo;for(var f in d)c(a,d[f],GO.query.type.UPDATE,e[f])})},k=function(){h(function(a){var d=b._getRecord().selection;for(var e in d)c(a,d[e],GO.query.type.DELETE)})};this.run=function(){switch(b._getRecord().type){case GO.query.type.SELECT:return i();case GO.query.type.UPDATE:return j();case GO.query.type.DELETE:return k();default:return null}}},GO.Core.Where=function(a){var b=a;a._setRecord("where",this),this.filter=null,this.where=function(a){switch(this.filter=a,b._getRecord().type){case GO.query.type.SELECT:this.orderBy=function(a,c){b._setRecord("orderby",{attribute:a,order:c})};break;case GO.query.type.UPDATE:this.set=function(){b._setRecord("updateTo",arguments)}}return new GO.Core.Processor(b)}};