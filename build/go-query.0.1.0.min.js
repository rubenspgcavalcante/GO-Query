/**
* GO Query!
* Query executor on js array of objects
* Build date: 2013-11-04
* @author Rubens Pinheiro GonÃ§alves Cavalcante
* @version 0.1.0
* @license GPLv3
*/
GO={},GO.Clause={},GO.Core={},GO.Error={},GO.query={},GO.query.type={SELECT:0,DELETE:1,UPDATE:2},GO.query.WILDCARD="*",GO.op={TAUTOLOGICAL:0,CONTRADICTORY:1,EQ:2,NEQ:3,GT:4,GTE:5,MT:6,MTE:7,LIKE:8,HAS:9},GO.order={ASC:0,DESC:1},GO.Filter=function(a,b,c){var d=this;a instanceof GO.Filter?this.associate=a||null:(this.attribute=a||null,this.operator=b||null,this.value=c||null);var e=null,f={and:null,or:null,xor:null},g=function(a,b,c,e){for(var g in f)f.hasOwnProperty(g)&&(g==a?(f[g]=new GO.Filter(b,c,e),f[g]._setParent(d)):f[g]=null);return f[a]};this._setParent=function(a){e=a},this.parent=function(){return e},this.child=function(){return f.and||f.or||f.xor},this.root=function(){for(var a=this;null!=a.parent();)a=a.parent();return a},this.isEmpty=function(){return this.hasOwnProperty("associate")?null==this.associate:null==this.attribute&&null==this.operator&&null==this.value},this.init=function(a,b,c){a instanceof GO.Filter?this.associate=a:(this.attribute=a,this.operator=b,this.value=c)},this.and=function(a,b,c){return g("and",a,b,c)},this.or=function(a,b,c){return g("or",a,b,c)},this.xor=function(a,b,c){return g("xor",a,b,c)}},GO.Query=function(a){this.collection=a;var b=new GO.Core.Record;this._getRecord=function(){return b},this._setRecord=function(a,c){b[a]=c},this.select=function(){return b.type=GO.query.type.SELECT,b.selection=arguments,new GO.Clause.From(this)},this.update=function(){return b.type=GO.query.type.UPDATE,new GO.Clause.From(this)},this.remove=function(){return b.type=GO.query.type.DELETE,b.selection=arguments,new GO.Clause.From(this)}},GO.Clause.From=function(a){var b=a;this.from=function(a){return"undefined"==typeof a&&(a=Object),b._setRecord("from",a),new GO.Clause.Where(b)}},GO.Clause.OrderBy=function(a,b){var c=a,d=b;this.val=function(){return{attribute:c,order:d}}},GO.Clause.Where=function(a){var b=a;a._setRecord("where",this),this.filter=null,this.where=function(a){switch(this.filter=a,b._getRecord().type){case GO.query.type.SELECT:this.orderBy=function(a,c){b._setRecord("orderby",new GO.OrderBy(a,c))};break;case GO.query.type.UPDATE:this.set=function(){b._setRecord("updateTo",arguments)}}return new GO.Core.Processor(b)}},GO.Core.Processor=function(a){var b=a,c=function(a,b,c,d){var e=b.indexOf("."),f=null;if(c=c||GO.query.type.SELECT,-1!=e){var g=b.slice(0,e);b=b.slice(e+1),f=a[g]||null}else f=a[b]||null;if(-1!=b.indexOf(".")&&null!=f)return _deepSearchAttribute(f,b);switch(c){case GO.query.type.SELECT:return f;case GO.query.type.UPDATE:a[b]=d;break;case GO.query.type.DELETE:delete a[b]}return null},d=function(a,b){var e=!1,f=c(a,b.attribute);return e=b.hasOwnProperty("associate")?d(a,b.associate):new GO.Core.Validator(b,f).test(),e?null!=b.child()?d(a,b.child()):!0:!1},e=function(a,b){var c={},d=b.indexOf(".");if(b==GO.query.WILDCARD)c=JSON.parse(JSON.stringify(a));else if(-1==d)c[b]="object"==typeof a[b]?JSON.parse(JSON.stringify(a[b])):a[b];else{var f=b.slice(0,d);b=b.slice(d+1),c[f]=a[f]||null,-1!=b.indexOf(".")?c[f]=e(c[f],b):"object"==typeof c[f]&&(c=JSON.parse(JSON.stringify(c)))}return c},f=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},g=function(a){var c=[],d=b._getRecord().selection;0==d.length&&(d=[GO.query.WILDCARD]);for(var g in a){var h={};for(var i in d)f(h,e(a[g],d[i]));c.push(h)}return c},h=function(a){for(var c in b.collection){var e=b.collection[c];e instanceof b._getRecord().from&&d(e,b._getRecord().where.filter)&&a(e)}},i=function(){var a=[];return h(function(b){a.push(b)}),g(a)},j=function(){h(function(a){var d=b._getRecord().selection,e=b._getRecord().updateTo;for(var f in d)c(a,d[f],GO.query.type.UPDATE,e[f])})},k=function(){h(function(a){var d=b._getRecord().selection;for(var e in d)c(a,d[e],GO.query.type.DELETE)})};this.run=function(){switch(b._getRecord().type){case GO.query.type.SELECT:return i();case GO.query.type.UPDATE:return j();case GO.query.type.DELETE:return k();default:throw new GO.Error.QueryMethodError("Query method not found",b._getRecord())}}},GO.Core.Record=function(){this.type=null,this.selection=null,this.from=null,this.where=null,this.orderby=null,this.updateTo=[]},GO.Core.Validator=function(a,b){var c=this;this.filter=a,this.value=b;var d=function(){if(c.value instanceof Array)for(var a in c.value)if(c.filter.value==c.value[a])return!0;return!1};this.test=function(){switch(this.filter.operator){case GO.op.EQ:return this.value==this.filter.value;case GO.op.NEQ:return this.value!=this.filter.value;case GO.op.GTE:return this.value>=this.filter.value;case GO.op.MTE:return this.value<=this.filter.value;case GO.op.GT:return this.value>this.filter.value;case GO.op.MT:return this.value<this.filter.value;case GO.op.LIKE:return this.filter.value instanceof RegExp&&this.filter.value.test(this.value);case GO.op.HAS:return d();case GO.op.TAUTOLOGICAL:return!0;case GO.op.CONTRADICTORY:return!1;default:throw GO.Error.OperatorError("Operator doesn't exist",this.filter)}}},GO.Error.OperatorError=function(a,b){this.name="OperatorError",this.message=a,this.data=b||null},GO.Error.OperatorError.prototype=new Error,GO.Error.OperatorError.constructor=GO.Error.OperatorError,GO.Error.QueryMethodError=function(a,b){this.name="QueryMethodError",this.message=a,this.data=b||null},GO.Error.QueryMethodError.prototype=new Error,GO.Error.QueryMethodError.constructor=GO.Error.QueryMethodError;