/**
* GO Query!
* Query executor on js array of objects
* Build date: 2013-11-17
* @author Rubens Pinheiro Gon√ßalves Cavalcante
* @version 0.1.0
* @license GPLv3
*/
GO={},GO.Clause={},GO.Core={},GO.Core.Modifier={},GO.Core.Helpers={},GO.Error={},GO.query={},GO.query.type={SELECT:0,DELETE:1,UPDATE:2},GO.query.logic_op={AND:0,OR:1,XOR:2},GO.query.WILDCARD="*",GO.op={TAUTOLOGICAL:0,CONTRADICTORY:1,EQ:2,NEQ:3,GT:4,GTE:5,MT:6,MTE:7,LIKE:8,HAS:9},GO.order={ASC:0,DESC:1},GO.Query=function(a){this.collection=a;var b=new GO.Core.Record;this._getRecord=function(){return b},this._setRecord=function(a,c){b[a]instanceof Array?b[a].push(c):b[a]=c},this.select=function(){return b.type=GO.query.type.SELECT,b.selection=arguments,new GO.Clause.From(this)},this.update=function(){return b.type=GO.query.type.UPDATE,new GO.Clause.From(this)},this.remove=function(){return b.type=GO.query.type.DELETE,b.selection=arguments,new GO.Clause.From(this)}},GO.Filter=function(a,b,c){a instanceof GO.Filter?this.associate=a||null:(this.attribute=a||null,this.operator=b||null,this.value=c||null);var d=null,e=null;this._setPredecessor=function(a){d=a},this._getFilterChain=function(){return e},this.back=function(){return d},this.next=function(){return e.link},this.root=function(){for(var a=this;null!=a.back();)a=a.back();return a},this.isEmpty=function(){return this.hasOwnProperty("associate")?null==this.associate:null==this.attribute&&null==this.operator&&null==this.value},this.init=function(a,b,c){a instanceof GO.Filter?this.associate=a:(this.attribute=a,this.operator=b,this.value=c)},this.and=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.AND,d),d},this.or=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.OR,d),d},this.xor=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.XOR,d),d}},GO.Error.CloneError=function(a){this.name="CloneError",this.message="Object couldn't be cloned. One or more inner attributes types are not supported",this.data=a||null},GO.Error.CloneError.prototype=new Error,GO.Error.CloneError.constructor=GO.Error.CloneError,GO.Error.NotImplementedError=function(a,b){this.name="NotImplementedError",this.message="Constructor must implement "+a,this.data=b||null},GO.Error.NotImplementedError.prototype=new Error,GO.Error.NotImplementedError.constructor=GO.Error.NotImplementedError,GO.Error.OperatorError=function(a,b){this.name="OperatorError",this.message=a,this.data=b||null},GO.Error.OperatorError.prototype=new Error,GO.Error.OperatorError.constructor=GO.Error.OperatorError,GO.Error.QueryMethodError=function(a,b){this.name="QueryMethodError",this.message=a,this.data=b||null},GO.Error.QueryMethodError.prototype=new Error,GO.Error.QueryMethodError.constructor=GO.Error.QueryMethodError,GO.Clause.From=function(a){var b=a;this.from=function(a){return"undefined"==typeof a&&(a=Object),b._setRecord("from",a),new GO.Clause.Where(b)}},GO.Clause.Where=function(a){var b=this,c=a;a._setRecord("where",this),this.filter=null;var d=function(){var a=c._getRecord();switch(a.type){case GO.query.type.SELECT:var d=new GO.Core.Modifier.OrderBy(a);b.orderBy=d.init;break;case GO.query.type.UPDATE:var e=new GO.Core.Modifier.Set(a);b.set=e.init}};this.where=function(a){return this.filter=a.root(),d(),new GO.Core.Processor(c)}},GO.Core.Modifier.PostProcess=function(a){this._collection=[],this._whereRef=null,this.modifierName=a,this.setCollection=function(a){this._collection=a},this.setWhereReference=function(a){this._whereRef=a},this.init=function(){throw new GO.Error.NotImplementedError("init",this.constructor)},this.modify=function(){throw new GO.Error.NotImplementedError("modify",this.constructor)}},GO.Core.Modifier.OrderBy=function(a){a.modifiers.push(this);var b=null,c=null;this.init=function(a,d){return b=a,c=d,this._whereRef},this.modify=function(){}},GO.Core.Modifier.OrderBy.prototype=new GO.Core.Modifier.PostProcess("OrderBy"),GO.Core.Modifier.OrderBy.constructor=GO.Core.Modifier.OrderBy,GO.Core.Modifier.Set=function(a){a.modifiers.push(this);var b=null;this.init=function(a){return b=a,this._whereRef},this.modify=function(){}},GO.Core.Modifier.Set.prototype=new GO.Core.Modifier.PostProcess("Set"),GO.Core.Modifier.Set.constructor=GO.Core.Modifier.Set,GO.Core.FilterChain=function(a,b){this.link=b,this.type=a},GO.Core.Processor=function(a){var b=a,c=function(a,b,c,d){var e=b.indexOf("."),f=null;if(c=c||GO.query.type.SELECT,-1!=e){var g=b.slice(0,e);b=b.slice(e+1),f=a[g]||null}else f=a[b]||null;if(-1!=b.indexOf(".")&&null!=f)return _deepSearchAttribute(f,b);switch(c){case GO.query.type.SELECT:return f;case GO.query.type.UPDATE:a[b]=d;break;case GO.query.type.DELETE:delete a[b]}return null},d=function(a,b){var e=!1;if(b.hasOwnProperty("associate"))e=d(a,b.associate);else{var f=c(a,b.attribute);e=new GO.Core.Validator(b,f).test()}var g=b._getFilterChain();if(null!=g){var h=GO.query.logic_op;switch(g.type){case h.AND:return e&&d(a,b.next());case h.OR:return e||d(a,b.next());case h.XOR:return e&&!d(a,b.next())||!e&&d(a,b.next())}}return e},e=function(a,b){var c={},d=b.indexOf(".");if(b==GO.query.WILDCARD)c=JSON.parse(JSON.stringify(a));else if(-1==d)c[b]="object"==typeof a[b]?JSON.parse(JSON.stringify(a[b])):a[b];else{var f=b.slice(0,d);b=b.slice(d+1),c[f]=a[f]||null,-1!=b.indexOf(".")?c[f]=e(c[f],b):"object"==typeof c[f]&&(c=JSON.parse(JSON.stringify(c)))}return c},f=function(a){var c=[],d=b._getRecord().selection;0==d.length&&(d=[GO.query.WILDCARD]);for(var f in a){var g={};for(var h in d)GO.Core.Helpers.objectMerge(g,e(a[f],d[h]));c.push(g)}return c},g=function(a){for(var c in b.collection){var e=b.collection[c];e instanceof b._getRecord().from&&d(e,b._getRecord().where.filter)&&a(e)}},h=function(){var a=[];return g(function(b){a.push(b)}),f(a)},i=function(){g(function(a){var d=b._getRecord().selection,e=b._getRecord().updateTo;for(var f in d)c(a,d[f],GO.query.type.UPDATE,e[f])})},j=function(){g(function(a){var d=b._getRecord().selection;for(var e in d)c(a,d[e],GO.query.type.DELETE)})},k=function(a){for(var c=b._getRecord().modifiers,d=0;d<c.length;d++)c[d].setCollection(a),c[d].modify();return a};this.run=function(){var a=null,c=b._getRecord();switch(c.type){case GO.query.type.SELECT:a=h();break;case GO.query.type.UPDATE:a=i();break;case GO.query.type.DELETE:a=j();break;default:throw new GO.Error.QueryMethodError("Query method not found",b._getRecord())}return k(a)}},GO.Core.Record=function(){this.type=null,this.selection=null,this.from=null,this.where=null,this.modifiers=[]},GO.Core.Validator=function(a,b){var c=this;this.filter=a,this.value=b;var d=function(){if(c.value instanceof Array)for(var a in c.value)if(c.filter.value==c.value[a])return!0;return!1};this.test=function(){switch(this.filter.operator){case GO.op.EQ:return this.value==this.filter.value;case GO.op.NEQ:return this.value!=this.filter.value;case GO.op.GTE:return this.value>=this.filter.value;case GO.op.MTE:return this.value<=this.filter.value;case GO.op.GT:return this.value>this.filter.value;case GO.op.MT:return this.value<this.filter.value;case GO.op.LIKE:return this.filter.value instanceof RegExp&&this.filter.value.test(this.value);case GO.op.HAS:return d();case GO.op.TAUTOLOGICAL:return!0;case GO.op.CONTRADICTORY:return!1;default:throw GO.Error.OperatorError("Operator doesn't exist",this.filter)}}},GO.Core.Helpers={deepSearch:function(a,b,c){var d=b.indexOf(".");if(-1!=d){var e=b.slice(0,d);return b=b.slice(d+1),GO.Core.Helpers.deepSearch(a[e],b,c)}return"undefined"==typeof c?a[b]:(a[b]=c,void 0)},deepSelection:function(a,b){var c=b.indexOf("."),d=null;if(-1==c)d[b]=GO.Core.Helpers.clone(a[b]);else{var e=b.slice(0,c);b=b.slice(c+1),d[e]=a[e]||null,-1!=b.indexOf(".")?d[e]=GO.Core.Helpers.deepSelection(d[e],b):d=GO.Core.Helpers.clone(a)}return d},clone:function(a){if(null==a||"object"!=typeof a)return a;var b=null;if(a instanceof Date)return b=new Date,b.setTime(a.getTime()),b;if(a instanceof Array){b=[];for(var c=0,d=a.length;d>c;c++)b[c]=clone(a[c]);return b}if(a instanceof Object){b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=clone(a[e]));return b}throw new GO.Error.CloneError(a)},objectMerge:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}};