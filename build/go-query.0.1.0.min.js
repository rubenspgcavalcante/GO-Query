/**
* GO Query!
* Query executor on js array of objects
* Build date: 2014-01-16
* @author Rubens Pinheiro Gon√ßalves Cavalcante
* @version 0.1.0
* @license GPLv3
*/
GO={},GO.Clause={},GO.Core={},GO.Core.Modifier={},GO.Core.Helpers={},GO.Error={},GO.query={},GO.query.type={SELECT:0,DELETE:1,UPDATE:2},GO.query.logic_op={AND:0,OR:1,XOR:2},GO.query.WILDCARD="*",GO.op={TAUTOLOGICAL:0,CONTRADICTORY:1,EQ:2,NEQ:3,GT:4,GTE:5,MT:6,MTE:7,LIKE:8,HAS:9},GO.order={ASC:0,DESC:1},GO.comparison={GREATER:1,EQUALS:0,LESSER:-1},GO.Query=function(a){this.collection=a;var b=new GO.Core.Record;this._getRecord=function(){return b},this._setRecord=function(a,c){b[a]instanceof Array?b[a].push(c):b[a]=c},this.select=function(){return b.type=GO.query.type.SELECT,b.selection=arguments,new GO.Clause.From(this)},this.update=function(){return b.type=GO.query.type.UPDATE,b.selection=GO.query.WILDCARD,new GO.Clause.From(this)},this.remove=function(){return b.type=GO.query.type.DELETE,b.selection=arguments,new GO.Clause.From(this)}},GO.Filter=function(a,b,c){a instanceof GO.Filter?this.associate=a||null:(this.attribute=a||null,this.operator=b||GO.op.TAUTOLOGICAL,this.value=c||null);var d=null,e=null;this._setPredecessor=function(a){d=a},this._getFilterChain=function(){return e},this.back=function(){return d},this.next=function(){return e.link},this.root=function(){for(var a=this;null!=a.back();)a=a.back();return a},this.isEmpty=function(){return this.hasOwnProperty("associate")?null==this.associate:null==this.attribute&&null==this.value},this.init=function(a,b,c){a instanceof GO.Filter?this.associate=a:(this.attribute=a,this.operator=b,this.value=c)},this.and=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.AND,d),d},this.or=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.OR,d),d},this.xor=function(a,b,c){var d=new GO.Filter(a,b,c);return d._setPredecessor(this),e=new GO.Core.FilterChain(GO.query.logic_op.XOR,d),d}},GO.Error.CloneError=function(a){this.name="CloneError",this.message="Object couldn't be cloned. One or more inner attributes types are not supported",this.data=a||null},GO.Error.CloneError.prototype=new Error,GO.Error.CloneError.constructor=GO.Error.CloneError,GO.Error.NotImplementedError=function(a,b){this.name="NotImplementedError",this.message="Constructor must implement "+a,this.data=b||null},GO.Error.NotImplementedError.prototype=new Error,GO.Error.NotImplementedError.constructor=GO.Error.NotImplementedError,GO.Error.OperatorError=function(a,b){this.name="OperatorError",this.message=a,this.data=b||null},GO.Error.OperatorError.prototype=new Error,GO.Error.OperatorError.constructor=GO.Error.OperatorError,GO.Error.QueryMethodError=function(a,b){this.name="QueryMethodError",this.message=a,this.data=b||null},GO.Error.QueryMethodError.prototype=new Error,GO.Error.QueryMethodError.constructor=GO.Error.QueryMethodError,GO.Clause.From=function(a){var b=a;this.from=function(a){return"undefined"==typeof a&&(a=Object),b._setRecord("from",a),new GO.Clause.Where(b)}},GO.Clause.Where=function(a){var b=a;a._setRecord("where",this);var c={};this.filter=null;var d=function(){var a=b._getRecord();switch(a.type){case GO.query.type.SELECT:c.orderBy=new GO.Core.Modifier.OrderBy(a);break;case GO.query.type.UPDATE:c.set=new GO.Core.Modifier.Set(a)}};this.where=function(a){return a=a||new GO.Filter("",GO.op.TAUTOLOGICAL,""),this.filter=a.root(),d(),new GO.Core.Processor(b,c)}},GO.Core.Modifier.PostProcess=function(a){this._processor=null,this.modifierName=a,this.setProcessorReference=function(a){this._processor=a},this.init=function(){throw new GO.Error.NotImplementedError("init",this.constructor)},this.modify=function(){throw new GO.Error.NotImplementedError("modify",this.constructor)}},GO.Core.Modifier.OrderBy=function(a){a.modifiers.push(this);var b=this,c=null,d=null,e=null;this.init=function(a,f,g){return c=a,d=f,e=g||null,b._processor},this.modify=function(a){null==e?(a.sort(),d==GO.order.DESC&&a.reverse()):a.sort(e)}},GO.Core.Modifier.OrderBy.prototype=new GO.Core.Modifier.PostProcess("OrderBy"),GO.Core.Modifier.OrderBy.constructor=GO.Core.Modifier.OrderBy,GO.Core.Modifier.Set=function(a){a.modifiers.push(this);var b=null,c=this;this.init=function(a){return b=a,c._processor},this.modify=function(a){for(var c=0;c<a.length;c++)for(var d in b)a[c].hasOwnProperty(d)&&(a[c][d]=b[d])}},GO.Core.Modifier.Set.prototype=new GO.Core.Modifier.PostProcess("Set"),GO.Core.FilterChain=function(a,b){this.link=b,this.type=a},GO.Core.Processor=function(a,b){var c=this,d=null;!function(){if(d=a,"undefined"!=typeof b)for(var e in b)b[e].setProcessorReference(c),c[e]=b[e].init}();var e=function(a,b,c){if(null==b)return null;var d=b.indexOf("."),e=null;if(c=c||GO.query.type.SELECT,-1!=d){var f=b.slice(0,d);b=b.slice(d+1),e=a[f]||null}else e=a[b]||null;if(-1!=b.indexOf(".")&&null!=e)return _deepSearchAttribute(e,b);switch(c){case GO.query.type.SELECT:case GO.query.type.UPDATE:return e;case GO.query.type.DELETE:delete a[b]}return null},f=function(a,b){var c=!1;if(b.hasOwnProperty("associate"))c=f(a,b.associate);else{var d=e(a,b.attribute);c=new GO.Core.Validator(b,d).test()}var g=b._getFilterChain();if(null!=g){var h=GO.query.logic_op;switch(g.type){case h.AND:return c&&f(a,b.next());case h.OR:return c||f(a,b.next());case h.XOR:return c&&!f(a,b.next())||!c&&f(a,b.next())}}return c},g=function(a,b){var c={},d=b.indexOf(".");if(b==GO.query.WILDCARD)c=a;else if(-1==d)c[b]="object"==typeof a[b]?JSON.parse(JSON.stringify(a[b])):a[b];else{var e=b.slice(0,d);b=b.slice(d+1),c[e]=a[e]||null,-1!=b.indexOf(".")?c[e]=g(c[e],b):"object"==typeof c[e]&&(c=JSON.parse(JSON.stringify(c)))}return c},h=function(a){var b=[],c=d._getRecord().selection;0==c.length&&(c=[GO.query.WILDCARD]);for(var e in a){var f={};for(var h in c)GO.Core.Helpers.objectMerge(f,g(a[e],c[h]));b.push(f)}return b},i=function(a){for(var b in d.collection){var c=d.collection[b];c instanceof d._getRecord().from&&f(c,d._getRecord().where.filter)&&a(c)}},j=function(){var a=[];return i(function(b){a.push(b)}),h(a)},k=function(){i(function(a){var b=d._getRecord().selection;for(var c in b)e(a,b[c],GO.query.type.DELETE)})},l=function(a){for(var b=d._getRecord().modifiers,c=0;c<b.length;c++)b[c].modify(a);return a};this.run=function(){var a=null,b=d._getRecord();switch(b.type){case GO.query.type.SELECT:case GO.query.type.UPDATE:a=j();break;case GO.query.type.DELETE:a=k();break;default:throw new GO.Error.QueryMethodError("Query method not found",d._getRecord())}return l(a)}},GO.Core.Record=function(){this.type=null,this.selection=null,this.from=null,this.where=null,this.modifiers=[]},GO.Core.Validator=function(a,b){var c=this;this.filter=a,this.value=b;var d=function(){if(c.value instanceof Array)for(var a in c.value)if(c.filter.value==c.value[a])return!0;return!1};this.test=function(){switch(this.filter.operator){case GO.op.EQ:return this.value==this.filter.value;case GO.op.NEQ:return this.value!=this.filter.value;case GO.op.GTE:return this.value>=this.filter.value;case GO.op.MTE:return this.value<=this.filter.value;case GO.op.GT:return this.value>this.filter.value;case GO.op.MT:return this.value<this.filter.value;case GO.op.LIKE:return this.filter.value instanceof RegExp&&this.filter.value.test(this.value);case GO.op.HAS:return d();case GO.op.TAUTOLOGICAL:return!0;case GO.op.CONTRADICTORY:return!1;default:throw new GO.Error.OperatorError("Operator doesn't exist",this.filter)}}},GO.Core.Helpers={deepSearch:function(a,b,c){var d=b.indexOf(".");if(-1!=d){var e=b.slice(0,d);return b=b.slice(d+1),GO.Core.Helpers.deepSearch(a[e],b,c)}return"undefined"==typeof c?a[b]:(a[b]=c,void 0)},deepSelection:function(a,b){var c=b.indexOf("."),d=null;if(-1==c)d[b]=GO.Core.Helpers.clone(a[b]);else{var e=b.slice(0,c);b=b.slice(c+1),d[e]=a[e]||null,-1!=b.indexOf(".")?d[e]=GO.Core.Helpers.deepSelection(d[e],b):d=GO.Core.Helpers.clone(a)}return d},clone:function(a){if(null==a||"object"!=typeof a)return a;var b=null;if(a instanceof Date)return b=new Date,b.setTime(a.getTime()),b;if(a instanceof Array){b=[];for(var c=0,d=a.length;d>c;c++)b[c]=clone(a[c]);return b}if(a instanceof Object){b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=clone(a[e]));return b}throw new GO.Error.CloneError(a)},objectMerge:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}};